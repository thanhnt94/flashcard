<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Th·∫ª - Flashcard App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Navbar Section -->
    <nav class="navbar">
        <div class="navbar-brand">Flashcard App</div>
        <div class="navbar-user-info">
            {% if session.get('username') %}
                <span>Xin ch√†o, {{ session.get('username') }}!</span>
                <a href="{{ url_for('main.logout') }}" class="button logout-button">ƒêƒÉng xu·∫•t</a>
            {% else %}
                <a href="{{ url_for('main.login') }}" class="button login-button">ƒêƒÉng nh·∫≠p</a>
            {% endif %}
        </div>
    </nav>

    <div class="main-container">
        {# TH√äM: M·ªôt div m·ªõi ƒë·ªÉ bao b·ªçc Flashcard ch√≠nh #}
        <div class="flashcard-column">
            {% if flashcard %}
                <div class="flashcard {% if not is_front %}is-back-side{% endif %}">
                    <!-- Flashcard Header -->
                    <div class="flashcard-header">
                        <p class="card-side">{% if is_front %}M·∫∑t tr∆∞·ªõc{% else %}M·∫∑t sau{% endif %}</p>
                        <button id="playAudioButton" class="play-audio-button" aria-label="Ph√°t √¢m thanh">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>

                    <!-- Flashcard Body (Content Area) -->
                    <div class="flashcard-body">
                        <div class="scrollable-card-content">
                            <div class="card-text">
                                {%- if is_front -%}
                                    {{- flashcard.front -}}
                                {%- else -%}
                                    {{- flashcard.back -}}
                                {%- endif -%}
                            </div>
                        </div>
                    </div>

                    <!-- Flashcard Footer (Buttons) -->
                    <div class="flashcard-footer">
                        {% if is_front %}
                            <a href="{{ url_for('main.flip_card', progress_id=progress.progress_id) }}" class="button">üîÑ L·∫≠t th·∫ª</a>
                        {% else %}
                            <div class="button-group">
                                {% if progress.last_reviewed is none %}
                                    <!-- Th·∫ª m·ªõi, ch·ªâ c√≥ n√∫t Ti·∫øp t·ª•c -->
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='continue') }}" class="button primary">‚ñ∂Ô∏è Ti·∫øp t·ª•c</a>
                                {% else %}
                                    <!-- Th·∫ª ƒë√£ h·ªçc, c√≥ c√°c n√∫t ƒë√°nh gi√° -->
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='forget') }}" class="button danger">‚ùå Qu√™n</a>
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='vague') }}" class="button warning">ü§î M∆° h·ªì</a>
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='remember') }}" class="button success">‚úÖ Nh·ªõ</a>
                                {% endif %}
                                <!-- N√∫t G·ª£i √Ω Ghi ch√∫ AI (ƒë√£ t·∫°m g√°c l·∫°i) -->
                                <!-- <button id="generateSmartNote" class="button ai-button">‚ú® G·ª£i √Ω Ghi ch√∫ ‚ú®</button> -->
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% elif wait_time_ts %}
                <div class="flashcard no-card">
                    <div class="flashcard-content">
                        <h2>üéâ Ho√†n th√†nh!</h2>
                        {% if is_midnight_tomorrow %}
                            <p>B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c th·∫ª c·∫ßn √¥n t·∫≠p ho·∫∑c th·∫ª m·ªõi cho h√¥m nay.</p>
                            <p>H√£y quay l·∫°i v√†o ng√†y mai ƒë·ªÉ ti·∫øp t·ª•c h·ªçc nh√©!</p>
                        {% else %}
                            <p>B·∫°n ƒë√£ √¥n h·∫øt c√°c th·∫ª ƒë·∫øn h·∫°n hi·ªán t·∫°i.</p>
                            <p>Th·∫ª ti·∫øp theo s·∫Ω ƒë·∫øn h·∫°n v√†o kho·∫£ng <strong>{{ wait_minutes }} ph√∫t</strong> n·ªØa.</p>
                        {% endif %}
                        <a href="{{ url_for('main.learn_set', set_id=context_stats.set_id) }}" class="button primary">‚ñ∂Ô∏è Ti·∫øp t·ª•c (th·ª≠ l·∫°i)</a>
                    </div>
                </div>
            {% else %}
                <div class="flashcard no-card">
                    <div class="flashcard-content">
                        <h2>Kh√¥ng c√≥ th·∫ª n√†o!</h2>
                        <p>Kh√¥ng t√¨m th·∫•y th·∫ª n√†o ƒë·ªÉ h·ªçc trong b·ªô n√†y.</p>
                        <a href="{{ url_for('main.select_set_page') }}" class="button primary">Ch·ªçn b·ªô kh√°c</a>
                    </div>
                </div>
            {% endif %}
        </div> {# K·∫æT TH√öC flashcard-column #}

        {# TH√äM: Khu v·ª±c hi·ªÉn th·ªã h√¨nh ·∫£nh d∆∞·ªõi d·∫°ng m·ªôt c·ªôt ri√™ng bi·ªát #}
        {% set image_src = '' %}
        {% if is_front and flashcard and flashcard.front_img %}
            {% set image_src = flashcard.front_img %}
        {% elif not is_front and flashcard and flashcard.back_img %}
            {% set image_src = flashcard.back_img %}
        {% endif %}

        {# THAY ƒê·ªîI QUAN TR·ªåNG: Ch·ªâ render flashcard-image-column n·∫øu c√≥ ·∫£nh #}
        {% if image_src %}
        <div class="flashcard-image-column">
            <div class="flashcard-image-container">
                <img src="{{ image_src }}" alt="H√¨nh ·∫£nh li√™n quan ƒë·∫øn th·∫ª" class="flashcard-image" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=Kh√¥ng+c√≥+·∫£nh'">
            </div>
        </div> {# K·∫æT TH√öC flashcard-image-column #}
        {% endif %}

        <!-- New container for the right column elements -->
        <div class="right-column-container">
            <!-- Separate frame for top controls, now a sibling to context-panel -->
            <div class="top-controls-frame">
                <h3>Ch·ªçn ch·ª©c nƒÉng</h3> {# Added title here #}
                <div class="control-button-group">
                    <a href="{{ url_for('main.select_set_page') }}" class="control-button set-button">üìö B·ªô</a>
                    <a href="{{ url_for('main.select_mode') }}" class="control-button mode-button">‚ö° Ch·∫ø ƒë·ªô</a>
                </div>
            </div>

            <!-- Context Panel (B·∫£ng th·ªëng k√™ nh·ªè) -->
            <div class="context-panel">
                <h2>üìä Th·ªëng k√™</h2>
                {% if context_stats %}
                    <!-- Box 1: Th·ªëng k√™ chung -->
                    <div class="stats-box general-stats">
                        <h3>T·ªïng quan chung</h3>
                        <p><strong>ƒêi·ªÉm c·ªßa b·∫°n:</strong> {{ context_stats.total_score }}</p>
                        <p><strong>ƒê√£ h·ªçc:</strong> {{ context_stats.learned_distinct_overall }} th·∫ª</p>
                        <p><strong>C·∫ßn √¥n:</strong> {{ context_stats.due_overall }} th·∫ª</p>
                        <p><strong>S·ªë b·ªô ƒë√£ h·ªçc:</strong> {{ context_stats.learned_sets_count }}</p>
                    </div>

                    <!-- Box 2: Ch·∫ø ƒë·ªô hi·ªán t·∫°i -->
                    <div class="stats-box mode-stats">
                        <h3>Ch·∫ø ƒë·ªô</h3>
                        <p><strong>Hi·ªán t·∫°i:</strong> {{ context_stats.current_mode_display }}</p>
                    </div>

                    <!-- Box 3: Th·ªëng k√™ b·ªô hi·ªán t·∫°i -->
                    <div class="stats-box set-stats">
                        <h3>B·ªô hi·ªán t·∫°i</h3>
                        <p><strong>B·ªô:</strong> {{ context_stats.set_title }}</p>
                        <p><strong>ƒê√£ h·ªçc trong b·ªô:</strong> {{ context_stats.set_learned_cards }} / {{ context_stats.set_total_cards }}</p>
                        <p><strong>C·∫ßn √¥n trong b·ªô:</strong> {{ context_stats.set_due_cards }}</p>
                    </div>

                    <!-- Box 4: Th·ªëng k√™ th·∫ª hi·ªán t·∫°i -->
                    {% if flashcard and progress %}
                    <div class="stats-box card-stats">
                        <h3>Th·∫ª hi·ªán t·∫°i</h3>
                        <p><strong>ID Th·∫ª:</strong> {{ flashcard.flashcard_id }}</p>
                        <p><strong>L·∫ßn ƒë√∫ng li√™n ti·∫øp:</strong> {{ progress.correct_streak }}</p>
                        <p><strong>T·ªïng s·ªë l·∫ßn ƒë√∫ng:</strong> {{ progress.correct_count }}</p>
                        <p><strong>T·ªïng l∆∞·ª£t √¥n:</strong> {{ progress.review_count }}</p>
                        <p><strong>Th·ªùi gian ƒë·∫øn h·∫°n:</strong> {{ progress.due_time | format_unix_timestamp }}</p>
                        <p><strong>L·∫ßn √¥n cu·ªëi:</strong> {{ progress.last_reviewed | format_unix_timestamp }}</p>
                    </div>
                    {% endif %}

                {% else %}
                    <p>Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™.</p>
                {% endif %}
                <div class="button-group">
                    {# Removed the "Ch·ªçn b·ªô kh√°c" button from here as per user's request #}
                </div>
            </div>
        </div>
    </div>

    {# TH√äM: Th·∫ª audio ƒë·ªÉ ph√°t √¢m thanh #}
    <audio id="cardAudioPlayer" controls style="display:none;"></audio>

    {# CH·ªàNH S·ª¨A: Hidden div ƒë·ªÉ l∆∞u tr·ªØ c√°c chu·ªói JSON ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ª´ Flask #}
    <div id="jsData"
        data-flashcard="{{ flashcard_json_string }}"
        data-is-front="{{ 'true' if is_front else 'false' }}"
        data-user-audio-settings="{{ user_audio_settings_json_string }}">
    </div>

    {# THAY TH·∫æ: Li√™n k·∫øt ƒë·∫øn file JavaScript b√™n ngo√†i #}
    <script src="{{ url_for('static', filename='js/learn_card_audio.js') }}"></script>
    <script src="{{ url_for('static', filename='js/card_content_adjuster.js') }}"></script> {# TH√äM: Li√™n k·∫øt ƒë·∫øn file card_content_adjuster.js #}

    {% if progress %}
    <div id="debugProgressId" data-progress-id="{{ progress.progress_id }}" style="display:none;"></div>
    {% endif %}
</body>
</html>
