<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Th·∫ª - Flashcard App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Navbar Section -->
    <nav class="navbar">
        <div class="navbar-brand">Flashcard App</div>
        <div class="navbar-user-info">
            {% if session.get('username') %}
                <span>Xin ch√†o, {{ session.get('username') }}!</span>
                <a href="{{ url_for('main.logout') }}" class="button logout-button">ƒêƒÉng xu·∫•t</a>
            {% else %}
                <a href="{{ url_for('main.login') }}" class="button login-button">ƒêƒÉng nh·∫≠p</a>
            {% endif %}
        </div>
    </nav>

    <div class="main-container">
        <!-- Flashcard Area -->
        <div class="flashcard-area">
            {% if flashcard %}
                <div class="flashcard {% if not is_front %}is-back-side{% endif %}"> {# THAY ƒê·ªîI: Th√™m l·ªõp is-back-side n·∫øu l√† m·∫∑t sau #}
                    <div class="flashcard-content">
                        {% if is_front %}
                            <p class="card-side">M·∫∑t tr∆∞·ªõc</p>
                            {# Added scrollable-card-content div #}
                            <div class="scrollable-card-content">
                                <div class="card-text">{{ flashcard.front }}</div>
                            </div>
                            <a href="{{ url_for('main.flip_card', progress_id=progress.progress_id) }}" class="button">üîÑ L·∫≠t th·∫ª</a>
                        {% else %}
                            <p class="card-side">M·∫∑t sau</p>
                            {# Added scrollable-card-content div #}
                            <div class="scrollable-card-content">
                                <div class="card-text">{{ flashcard.back }}</div>
                            </div>
                            <div class="button-group">
                                {% if progress.last_reviewed is none %}
                                    <!-- Th·∫ª m·ªõi, ch·ªâ c√≥ n√∫t Ti·∫øp t·ª•c -->
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response=2) }}" class="button primary">‚ñ∂Ô∏è Ti·∫øp t·ª•c</a>
                                {% else %}
                                    <!-- Th·∫ª ƒë√£ h·ªçc, c√≥ c√°c n√∫t ƒë√°nh gi√° -->
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response=-1) }}" class="button danger">‚ùå Qu√™n</a>
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response=0) }}" class="button warning">ü§î M∆° h·ªì</a>
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response=1) }}" class="button success">‚úÖ Nh·ªõ</a>
                                {% endif %}
                                <!-- N√∫t G·ª£i √Ω Ghi ch√∫ AI (ƒë√£ t·∫°m g√°c l·∫°i) -->
                                <!-- <button id="generateSmartNote" class="button ai-button">‚ú® G·ª£i √Ω Ghi ch√∫ ‚ú®</button> -->
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% elif wait_time_ts %}
                <div class="flashcard no-card">
                    <div class="flashcard-content">
                        <h2>üéâ Ho√†n th√†nh!</h2>
                        {% if is_midnight_tomorrow %}
                            <p>B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c th·∫ª c·∫ßn √¥n t·∫≠p ho·∫∑c th·∫ª m·ªõi cho h√¥m nay.</p>
                            <p>H√£y quay l·∫°i v√†o ng√†y mai ƒë·ªÉ ti·∫øp t·ª•c h·ªçc nh√©!</p>
                        {% else %}
                            <p>B·∫°n ƒë√£ √¥n h·∫øt c√°c th·∫ª ƒë·∫øn h·∫°n hi·ªán t·∫°i.</p>
                            <p>Th·∫ª ti·∫øp theo s·∫Ω ƒë·∫øn h·∫°n v√†o kho·∫£ng <strong>{{ wait_minutes }} ph√∫t</strong> n·ªØa.</p>
                        {% endif %}
                        <a href="{{ url_for('main.learn_set', set_id=context_stats.set_id) }}" class="button primary">‚ñ∂Ô∏è Ti·∫øp t·ª•c (th·ª≠ l·∫°i)</a>
                    </div>
                </div>
            {% else %}
                <div class="flashcard no-card">
                    <div class="flashcard-content">
                        <h2>Kh√¥ng c√≥ th·∫ª n√†o!</h2>
                        <p>Kh√¥ng t√¨m th·∫•y th·∫ª n√†o ƒë·ªÉ h·ªçc trong b·ªô n√†y.</p>
                        <a href="{{ url_for('main.select_set_page') }}" class="button primary">Ch·ªçn b·ªô kh√°c</a>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- New container for the right column elements -->
        <div class="right-column-container">
            <!-- Separate frame for top controls, now a sibling to context-panel -->
            <div class="top-controls-frame">
                <h3>Ch·ªçn ch·ª©c nƒÉng</h3> {# Added title here #}
                <div class="control-button-group">
                    <a href="{{ url_for('main.select_set_page') }}" class="control-button set-button">üìö B·ªô</a>
                    <a href="{{ url_for('main.select_mode') }}" class="control-button mode-button">‚ö° Ch·∫ø ƒë·ªô</a>
                </div>
            </div>

            <!-- Context Panel (B·∫£ng th·ªëng k√™ nh·ªè) -->
            <div class="context-panel">
                <h2>üìä Th·ªëng k√™</h2>
                {% if context_stats %}
                    <!-- Box 1: Th·ªëng k√™ chung -->
                    <div class="stats-box general-stats">
                        <h3>T·ªïng quan chung</h3>
                        <p><strong>ƒêi·ªÉm c·ªßa b·∫°n:</strong> {{ context_stats.total_score }}</p>
                        <p><strong>ƒê√£ h·ªçc:</strong> {{ context_stats.learned_distinct_overall }} th·∫ª</p>
                        <p><strong>C·∫ßn √¥n:</strong> {{ context_stats.due_overall }} th·∫ª</p>
                        <p><strong>S·ªë b·ªô ƒë√£ h·ªçc:</strong> {{ context_stats.learned_sets_count }}</p>
                    </div>

                    <!-- Box 2: Ch·∫ø ƒë·ªô hi·ªán t·∫°i -->
                    <div class="stats-box mode-stats">
                        <h3>Ch·∫ø ƒë·ªô</h3>
                        <p><strong>Hi·ªán t·∫°i:</strong> {{ context_stats.current_mode_display }}</p>
                    </div>

                    <!-- Box 3: Th·ªëng k√™ b·ªô hi·ªán t·∫°i -->
                    <div class="stats-box set-stats">
                        <h3>B·ªô hi·ªán t·∫°i</h3>
                        <p><strong>B·ªô:</strong> {{ context_stats.set_title }}</p>
                        <p><strong>ƒê√£ h·ªçc trong b·ªô:</strong> {{ context_stats.set_learned_cards }} / {{ context_stats.set_total_cards }}</p>
                        <p><strong>C·∫ßn √¥n trong b·ªô:</strong> {{ context_stats.set_due_cards }}</p>
                    </div>

                    <!-- Box 4: Th·ªëng k√™ th·∫ª hi·ªán t·∫°i -->
                    {% if flashcard and progress %}
                    <div class="stats-box card-stats">
                        <h3>Th·∫ª hi·ªán t·∫°i</h3>
                        <p><strong>ID Th·∫ª:</strong> {{ flashcard.flashcard_id }}</p>
                        <p><strong>L·∫ßn ƒë√∫ng li√™n ti·∫øp:</strong> {{ progress.correct_streak }}</p>
                        <p><strong>T·ªïng s·ªë l·∫ßn ƒë√∫ng:</strong> {{ progress.correct_count }}</p>
                        <p><strong>T·ªïng l∆∞·ª£t √¥n:</strong> {{ progress.review_count }}</p>
                        <p><strong>Th·ªùi gian ƒë·∫øn h·∫°n:</strong> {{ progress.due_time | format_unix_timestamp }}</p>
                        <p><strong>L·∫ßn √¥n cu·ªëi:</strong> {{ progress.last_reviewed | format_unix_timestamp }}</p>
                    </div>
                    {% endif %}

                {% else %}
                    <p>Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™.</p>
                {% endif %}
                <div class="button-group">
                    {# Removed the "Ch·ªçn b·ªô kh√°c" button from here as per user's request #}
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Note Modal (ƒë√£ t·∫°m g√°c l·∫°i) -->
    <!--
    <div id="smartNoteModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>‚ú® G·ª£i √Ω Ghi ch√∫ Th√¥ng minh ‚ú®</h2>
            <div id="smartNoteContent" class="modal-body">
                <p>ƒêang t·∫°o ghi ch√∫...</p>
            </div>
            <div class="modal-footer">
                <button id="copySmartNote" class="button primary">Sao ch√©p</button>
                <button id="closeSmartNoteModal" class="button secondary">ƒê√≥ng</button>
            </div>
        </div>
    </div>
    -->

    <!-- Smart Note Script (ƒë√£ t·∫°m g√°c l·∫°i) -->
    <!--
    <script>
        const generateButton = document.getElementById('generateSmartNote');
        const smartNoteModal = document.getElementById('smartNoteModal');
        const smartNoteContent = document.getElementById('smartNoteContent');
        const closeButton = document.querySelector('.close-button');
        const copyButton = document.getElementById('copySmartNote');
        const closeModalButton = document.getElementById('closeSmartNoteModal');

        const flashcardFront = "{{ flashcard.front | e }}";
        const flashcardBack = "{{ flashcard.back | e }}";

        if (generateButton) {
            generateButton.addEventListener('click', async () => {
                smartNoteModal.style.display = 'block';
                smartNoteContent.innerHTML = '<p>ƒêang t·∫°o ghi ch√∫ th√¥ng minh... Vui l√≤ng ch·ªù.</p><div class="loader"></div>';
                copyButton.style.display = 'none';

                try {
                    const response = await fetch('/generate_smart_note', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            front: flashcardFront,
                            back: flashcardBack
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.note) {
                        smartNoteContent.innerHTML = `<p>${data.note}</p>`;
                        copyButton.style.display = 'inline-block';
                    } else {
                        smartNoteContent.innerHTML = '<p>Kh√¥ng th·ªÉ t·∫°o ghi ch√∫ th√¥ng minh. Vui l√≤ng th·ª≠ l·∫°i.</p>';
                    }
                } catch (error) {
                    console.error('L·ªói khi t·∫°o ghi ch√∫ th√¥ng minh:', error);
                    smartNoteContent.innerHTML = '<p>ƒê√£ x·∫£y ra l·ªói khi t·∫°o ghi ch√∫. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
                }
            });
        }

        closeButton.addEventListener('click', () => {
            smartNoteModal.style.display = 'none';
        });

        closeModalButton.addEventListener('click', () => {
            smartNoteModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == smartNoteModal) {
                smartNoteModal.style.display = 'none';
            }
        });

        copyButton.addEventListener('click', () => {
            const textToCopy = smartNoteContent.innerText;
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('ƒê√£ sao ch√©p ghi ch√∫ v√†o clipboard!');
            } catch (err) {
                console.error('Kh√¥ng th·ªÉ sao ch√©p vƒÉn b·∫£n: ', err);
                alert('Kh√¥ng th·ªÉ sao ch√©p ghi ch√∫. Vui l√≤ng sao ch√©p th·ªß c√¥ng.');
            }
            document.body.removeChild(textarea);
        });
    </script>
    -->

    <script>
        // Debugging: Log progress_id when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const progressIdElement = document.getElementById('debugProgressId');
            if (progressIdElement) {
                console.log('Debug: progress.progress_id from Jinja2:', progressIdElement.dataset.progressId);
            } else {
                console.log('Debug: progressIdElement not found. progress object might not be available.');
            }
        });
    </script>
    {% if progress %}
    <div id="debugProgressId" data-progress-id="{{ progress.progress_id }}" style="display:none;"></div>
    {% endif %}
</body>
</html>
