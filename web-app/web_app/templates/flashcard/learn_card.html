{% extends 'base.html' %}

{% block title %}H·ªçc Th·∫ª - Flashcard App{% endblock %}

{% block content %}
    <div class="main-container">
        <div class="flashcard-column">
            <div class="flashcard {% if not is_front %}is-back-side{% endif %}">

                <!-- Flashcard Header -->
                <div class="flashcard-header">
                    <button id="menu-toggle-btn" class="menu-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>

                    <p class="card-side">{% if is_front %}M·∫∑t tr∆∞·ªõc{% else %}M·∫∑t sau{% endif %}</p>
                    <button id="playAudioButton" class="play-audio-button" aria-label="Ph√°t √¢m thanh">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>

                <!-- Flashcard Body (Content Area) -->
                <div class="flashcard-body">
                    <div class="scrollable-card-content">
                        <div class="card-text">
                            {%- if is_front -%}
                                {{- flashcard.front -}}
                            {%- else -%}
                                {{- flashcard.back -}}
                            {%- endif -%}
                        </div>
                    </div>
                </div>

                {# Popup h√¨nh ·∫£nh (kh√¥ng ƒë·ªïi) #}
                {% set show_image_popup = (is_front and flashcard.front_img and user.front_image_enabled == 1) or (not is_front and flashcard.back_img and user.back_image_enabled == 1) %}
                {% if show_image_popup %}
                    {% set image_src = url_for('main.serve_image', filename=(flashcard.front_img if is_front else flashcard.back_img)) %}
                    <div id="image-popup" class="image-popup-container">
                        <button id="close-image-popup-btn" class="close-popup-btn">&times;</button>
                        <img src="{{ image_src }}" alt="H√¨nh ·∫£nh th·∫ª" class="popup-image">
                    </div>
                {% endif %}

                <!-- Flashcard Footer (Buttons) -->
                <div class="flashcard-footer">
                    {% if is_autoplay_mode %}
                        {% if is_front %}
                            <a href="{{ url_for('main.flip_card', progress_id=progress.progress_id) }}" class="button">üîÑ L·∫≠t th·∫ª</a>
                        {% else %}
                            <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='next') }}" class="button primary">‚ñ∂Ô∏è Ti·∫øp theo</a>
                        {% endif %}
                    {% else %}
                        <div class="button-group">
                            {% if is_front %}
                                <a href="{{ url_for('main.flip_card', progress_id=progress.progress_id) }}" class="button">üîÑ L·∫≠t th·∫ª</a>
                            {% else %}
                                {% if progress.last_reviewed is none %}
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='continue') }}" class="button primary">‚ñ∂Ô∏è Ti·∫øp t·ª•c</a>
                                {% else %}
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='forget') }}" class="button danger">‚ùå Qu√™n</a>
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='vague') }}" class="button warning">ü§î M∆° h·ªì</a>
                                    <a href="{{ url_for('main.rate_card', progress_id=progress.progress_id, response_str='remember') }}" class="button success">‚úÖ Nh·ªõ</a>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# ========================== C·∫¨P NH·∫¨T PANEL ƒêI·ªÄU H∆Ø·ªöNG ========================== #}
    <div id="side-nav-overlay" class="side-nav-overlay"></div>
    <nav id="side-nav" class="side-nav">
        <div class="side-nav-header">
            {# Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng #}
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <span class="username">{{ user.username or 'User' }}</span>
                    <span class="score">ƒêi·ªÉm: {{ context_stats.total_score or 0 }}</span>
                </div>
            </div>
            <button id="side-nav-close-btn" class="side-nav-close-btn">&times;</button>
        </div>

        {# Th√™m c√°c kh·ªëi th√¥ng tin #}
        <div class="side-nav-content">
            <div class="nav-section">
                <h3 class="nav-section-title">B·ªô th·∫ª hi·ªán t·∫°i</h3>
                <p>{{ context_stats.set_title }}</p>
                <p>Ti·∫øn ƒë·ªô: {{ context_stats.set_learned_cards }} / {{ context_stats.set_total_cards }} th·∫ª</p>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Th·ªëng k√™ nhanh</h3>
                <p>Th·∫ª c·∫ßn √¥n: {{ context_stats.due_overall }}</p>
            </div>

            <ul class="side-nav-links">
                <li><a href="{{ url_for('main.select_set_page') }}"><i class="fas fa-layer-group"></i> Ch·ªçn B·ªô Kh√°c</a></li>
                <li><a href="{{ url_for('main.select_mode') }}"><i class="fas fa-bolt"></i> ƒê·ªïi Ch·∫ø ƒê·ªô</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</a></li> {# N√∫t c√†i ƒë·∫∑t (ch∆∞a c√≥ ch·ª©c nƒÉng) #}
                <hr>
                <li><a href="{{ url_for('main.logout') }}"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </div>
    </nav>
    {# =================================================================================== #}

    {# ... c√°c div ·∫©n v√† th·∫ª audio kh√¥ng ƒë·ªïi ... #}
{% endblock %}

{% block scripts_extra %}
    {# ... c√°c script c≈© kh√¥ng ƒë·ªïi ... #}
    <script src="{{ url_for('static', filename='js/learn_card_audio.js') }}"></script>
    <script src="{{ url_for('static', filename='js/card_content_adjuster.js') }}"></script>
    <script src="{{ url_for('static', filename='js/image_popup_handler.js') }}"></script>
    
    {# Th√™m script m·ªõi cho menu #}
    <script src="{{ url_for('static', filename='js/mobile_menu_handler.js') }}"></script>
{% endblock %}
