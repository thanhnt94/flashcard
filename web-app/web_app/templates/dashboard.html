{% extends 'base.html' %}
{% block title %}Bảng điều khiển - Thống kê{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1 class="dashboard-header"><i class="fas fa-chart-pie"></i> Bảng điều khiển Thống kê</h1>

    <div class="stats-section">
        <h2 class="section-title">Tổng quan</h2>
        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="stat-card-icon score"><i class="fas fa-star"></i></div>
                <div class="stat-card-info">
                    <span class="stat-card-value">{{ dashboard_data.total_score }}</span>
                    <span class="stat-card-label">Tổng điểm</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon learned"><i class="fas fa-graduation-cap"></i></div>
                <div class="stat-card-info">
                    <span class="stat-card-value">{{ dashboard_data.learned_distinct_overall }}</span>
                    <span class="stat-card-label">Thẻ đã học</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon sets"><i class="fas fa-layer-group"></i></div>
                <div class="stat-card-info">
                    <span class="stat-card-value">{{ dashboard_data.learned_sets_count }}</span>
                    <span class="stat-card-label">Bộ đã học</span>
                </div>
            </div>
        </div>
    </div>

    {# --- Lịch Nhiệt Hoạt Động --- #}
    <div class="stats-section">
        <h2 class="section-title">Lịch sử hoạt động</h2>
        <div id="heatmap-container" class="heatmap-container"></div>
        <div class="heatmap-legend">
            <span>Ít</span>
            <div class="legend-color-box" data-level="1"></div>
            <div class="legend-color-box" data-level="2"></div>
            <div class="legend-color-box" data-level="3"></div>
            <div class="legend-color-box" data-level="4"></div>
            <span>Nhiều</span>
        </div>
    </div>

    <div class="stats-section">
        <h2 class="section-title">Hoạt động 30 ngày qua</h2>
        <div class="chart-controls">
            <label class="chart-toggle"><input type="checkbox" class="chart-toggle-checkbox" data-dataset-index="0" checked><span class="toggle-label color-reviews">Số lần ôn tập</span></label>
            <label class="chart-toggle"><input type="checkbox" class="chart-toggle-checkbox" data-dataset-index="1" checked><span class="toggle-label color-reviewed-cards">Số thẻ ôn tập</span></label>
            <label class="chart-toggle"><input type="checkbox" class="chart-toggle-checkbox" data-dataset-index="2" checked><span class="toggle-label color-new-cards">Thẻ học mới</span></label>
            <label class="chart-toggle"><input type="checkbox" class="chart-toggle-checkbox" data-dataset-index="3" checked><span class="toggle-label color-score">Điểm đạt được</span></label>
        </div>
        <div class="chart-container"><canvas id="activityChart"></canvas></div>
    </div>

    <div class="stats-section">
        <h2 class="section-title">Chi tiết theo bộ</h2>
        {% if dashboard_data.sets_stats %}
            <div class="set-selector-container" data-current-set-id="{{ current_set_id or '' }}">
                <label for="setSelector">Chọn một bộ để xem chi tiết:</label>
                <select id="setSelector" class="form-control">
                    <option value="">-- Chọn bộ thẻ --</option>
                    {% for set_id, set_data in dashboard_data.sets_stats.items() %}
                        <option value="{{ set_id }}">{{ set_data.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="set-details-container" style="display: none;"></div>
        {% else %}
            <p>Bạn chưa học bộ thẻ nào để xem thống kê chi tiết.</p>
        {% endif %}
    </div>
</div>

<div id="card-list-modal" class="card-list-modal" style="display: none;">
    <div class="card-list-modal-content">
        <span id="card-list-modal-close-btn" class="card-list-modal-close-btn">&times;</span>
        <h2 id="card-list-modal-title">Danh sách thẻ</h2>
        <div id="card-list-container" class="card-list-container"></div>
        <div id="card-list-pagination" class="card-list-pagination"></div>
    </div>
</div>

<script id="dashboard-data" type="application/json">{{ dashboard_data_json | safe }}</script>
{% endblock %}

{% block scripts_extra %}
    <script src="{{ url_for('static', filename='js/dashboard_charts.js') }}"></script>
{% endblock %}